package require tcltest
namespace import ::tcltest::*

::tcltest::configure {*}$argv

::tcltest::loadTestedCommands

package require automata::machine

if no {
    set mc KTR
    set m [subst {::automata::$mc create M}]
    {*}$m
    M doc [file join ~ code automata-as-tools.wiki class.$mc.md]
    M destroy
}

test ktr-1.0 {} -body {
    ::automata::KTR create M {
        code {
            a:          TEST:next-to-a-beeper
                        JNZ:end,0
                        TEST:right-is-clear
                        JZ:b,0
                        CALL:turnright
                        J:c
            b:          TEST:front-is-clear
                        JNZ:c,0
                        TURN
                        J:b
            c:          MOVE
                        J:a
            end:        HALT
            turnright:  TURN TURN TURN RET
        }
    }
    M run {3 3} {1 1 0 e} {3 2} {2 1 2 2}
} -cleanup {
    M destroy
    log::lvSuppressLE i 1
} -result {{3 3} {3 2 0 s} {} {3 2} {2 1 2 2} 0 12}

test ktr-1.1 {print 1.0} -body {
    ::automata::KTR create M {
        code {
            a:          TEST:next-to-a-beeper
                        JNZ:end,0
                        TEST:right-is-clear
                        JZ:b,0
                        CALL:turnright
                        J:c
            b:          TEST:front-is-clear
                        JNZ:c,0
                        TURN
                        J:b
            c:          MOVE
                        J:a
            end:        HALT
            turnright:  TURN TURN TURN RET
        }
    }
    M print
} -cleanup {
    M destroy
    log::lvSuppressLE i 1
} -output {Code
a           TEST  next  to a
            JNZ   end   0 
            TEST  right is clear
            JZ    b     0 
            CALL  turnright 
            J     c      
b           TEST  front is clear
            JNZ   c     0 
            TURN         
            J     b      
c           MOVE         
            J     a      
end         HALT         
turnright   TURN         
            TURN         
            TURN         
            RET          
Instantaneous description: width, height, xpos, ypos, bag, facing, returns, beepers, walls, flag, ipointer
}

if {[package vcompare [package present automata::machine] 0.4] > 0} { 
    cleanupTests ; return 
} 
 

cleanupTests ; return ; # ---------------------------------
