package require tcltest
namespace import ::tcltest::*

::tcltest::configure {*}$argv

::tcltest::testConstraint noskip 1

::tcltest::loadTestedCommands

package require automata::automaton

if no {
    set mc PDA
    set m [subst {::automata::$mc create M}]
    {*}$m
    M doc [file join ~ code automata-as-tools.wiki class.$mc.md]
    M destroy
}

test pda-1.0 {0^n1^n | n >= 0} -setup {
    ::automata::PDA create M {
        tuples {*}{
            {p 0/Z;AZ p}
            {p 0/A;AA p}
            {p _/Z;Z  q}
            {p _/A;A  q}
            {q 1/A;_  q}
            {q _/Z;Z  r}
        }
        start p
        final r
        stack Z
    }
} -body {
    M accept {}
} -cleanup {
    M destroy
    log::lvSuppressLE i 1
} -result 1

test pda-1.1 {0^n1^n | n >= 0} -setup {
    ::automata::PDA create M {
        tuples {*}{
            {p 0/Z;AZ p}
            {p 0/A;AA p}
            {p _/Z;Z  q}
            {p _/A;A  q}
            {q 1/A;_  q}
            {q _/Z;Z  r}
        }
        start p
        final r
        stack Z
    }
} -body {
    M accept {0 0 0 0 1 1 1 1}
} -cleanup {
    M destroy
    log::lvSuppressLE i 1
} -result 1

test pda-1.2 {} -setup {
    ::automata::PDA create M {
        tuples {*}{
            {p 0/Z;AZ p}
            {p 0/A;AA p}
            {p _/Z;Z  q}
            {p _/A;A  q}
            {q 1/A;_  q}
            {q _/Z;Z  r}
        }
        start p
        final r
        stack Z
    }
} -body {
    set res {}
    lappend res [M accept {0 0 0 0 1 1 1 1 1}]
    lappend res [M accept {1 1 0}]
    lappend res [M accept {0 1}]
    lappend res [M accept {0 0 0 1 1 1}]
    set res
} -cleanup {
    M destroy
    log::lvSuppressLE i 1
} -result {0 0 1 1}

test pda-1.3 {} -constraints PRINT -setup {
    ::automata::PDA create M {
        tuples {*}{
            {p 0/Z;AZ p}
            {p 0/A;AA p}
            {p _/Z;Z  q}
            {p _/A;A  q}
            {q 1/A;_  q}
            {q _/Z;Z  r}
        }
        start p
        final r
        stack Z
    }
} -body {
    M print
} -cleanup {
    M destroy
    log::lvSuppressLE i 1
} -output {Input symbols     A = {0, 1}
Stack symbols     B = {Z, A}
State symbols     Q = {p, q, r}
Start symbol      S = p
Initial stack     Z = Z
Final symbols     F = {r}
Transitions
q0    inp   q1    out
p     0     p     Z {A Z}
p     0     p     A {A A}
p     ε     q     Z Z
p     ε     q     A A
q     1     q     A {}
q     ε     r     Z Z
Instantaneous description
remaining input        input: A*
current state          state: Q
current stack          stack: B*
}

if {[package vcompare [package present automata::automaton] 0.4] > 0} { 
    cleanupTests ; return 
} 
 
cleanupTests ; return
